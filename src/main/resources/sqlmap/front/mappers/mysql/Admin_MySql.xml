<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.xicom.front.service.mapper.AdminMapper">
    <resultMap id="TraceVO" type="kr.co.xicom.front.model.TraceVO">
        <result property="seq" column="seq"/>
        <result property="title" column="title"/>
        <result property="cont" column="cont"/>
        <result property="rgst_dt" column="rgst_dt"/>
        <result property="imgPath" column="img_path"/>
    </resultMap>
    <resultMap id="CmpMemberVo" type="kr.co.xicom.front.model.CmpMemberVo">
        <result property="bizNo" column="bizNo"/>
        <result property="mem_cd" column="mem_cd"/>
        <result property="cmpNm" column="cmpNm"/>
        <result property="fdate" column="fdate"/>
        <result property="ceo" column="ceo"/>
        <result property="address" column="address"/>
        <result property="address_dtl" column="address_dtl"/>
        <result property="telNo" column="telNo"/>
        <result property="faxNo" column="faxNo"/>
        <result property="bizType" column="bizType"/>
        <result property="capital" column="capital"/>
        <result property="product" column="product"/>
        <result property="conQ" column="conQ"/>
        <result property="deal_type" column="deal_type"/>
        <result property="deal_scale" column="deal_scale"/>
        <result property="material" column="material"/>
        <result property="appdate" column="appdate"/>
        <result property="name" column="name"/>
        <result property="deptNm" column="deptNm"/>
        <result property="position" column="position"/>
        <result property="mbphno" column="mbphno"/>
        <result property="email" column="email"/>
        <result property="memTelNo" column="memTelNo"/>
        <result property="memFaxNo" column="memFaxNo"/>
    </resultMap>
    <resultMap id="RcmdVO" type="kr.co.xicom.front.model.RcmdVO">
        <result property="rcmd_no" column="remd_no"/>
        <result property="status" column="status"/>
        <result property="apply_cmpNm" column="apply_cmpNm"/>
        <result property="apply_bizno" column="apply_bizno"/>
        <result property="apply_ceo" column="apply_ceo"/>
        <result property="apply_telNo" column="apply_telNo"/>
        <result property="apply_email" column="apply_email"/>
        <result property="rcmd_cmpNm" column="rcmd_cmpNm"/>
        <result property="rcmd_bizno" column="rcmd_bizno"/>
        <result property="rcmd_telNo" column="rcmd_telNo"/>
        <result property="rcmd_email" column="rcmd_email"/>
        <result property="rcmd_detail" column="rcmd_detail"/>
        <result property="appdt" column="appdt"/>
    </resultMap>
    <resultMap id="BannerVO" type="kr.co.xicom.front.model.BannerVO">
        <result property="banSeq" column="ban_sn"/>
        <result property="banNm" column="ban_nm"/>
        <result property="siteUrl" column="site_url"/>
        <result property="stts" column="stts"/>
        <result property="sortSeq" column="sort_seq"/>
        <result property="banTy" column="ban_ty"/>
        <result property="registDt" column="regist_dt"/>
        <result property="upDt" column="up_dt"/>
        <result property="fileNm" column="file_nm"/>
        <result property="fileSize" column="file_sise"/>
        <result property="fileType" column="file_ty"/>
        <result property="savedPath" column="saved_path"/>
        <result property="savedFileName" column="saved_file_nm"/>
    </resultMap>
    <select id="joinList" resultMap="CmpMemberVo">
        select
            A.bizno as bizNo
             ,A.cmp_mbr_cd as mem_cd
             ,A.cmp_nm as cmpNm
             ,to_char(A.appdt, 'YYYY-MM-DD') as appdate
             ,B.nm as name
             ,B.user_id as id
             ,B.pswd as passwd
             , a.logo_img_path as logoImgPath
             , a.updt as update
             , a.joincmp as joinCmp
        from tb_pils_cmpmbr A join tb_pils_mbr B
                                   on A.bizno =B.bizno
        where cmp_mbr_cd= #{mem_cd}
            and b.manage_cd ='M501'
            <if test="tag != null and tag != ''">
                and ${tag} like CONCAT('%',#{keyword},'%')
            </if>
        <choose>
            <when test="sort == 'cmp_nm' or sort == 'nm'">
               order by ${sort} asc
            </when>
            <when test="sort == 'joincmp' or sort == 'appdt' or sort == 'upd_dt'">
                order by ${sort} desc
            </when>
            <otherwise>
                order by appdt desc
            </otherwise>
        </choose>
        <if test="pageIndex > 0">
            LIMIT #{pageUnit} OFFSET #{firstIndex}
        </if>
    </select>
    <select id="memInfo" resultMap="CmpMemberVo">
        select cmp_nm        as cmpNm
             , bizno         as bizNo
             , cmp_mbr_cd    as mem_cd
             , ceo           as ceo
             , fdate         as fdate
             , addr          as address
             , addr_dtl      as address_dtl
             , telno         as telNo
             , faxno         as faxno
             , biz_ty        as bizType
             , capl          as capital
             , deal_ty       as deal_type
             , yr_deal_scale as deal_scale
             , prmy_mat      as material
             , con_q         as conQ
             , product       as product
             , joincmp       as joinCmp
             , main_product   as mainProduct
        from tb_pils_cmpmbr
        where cmp_mbr_cd = #{mem_cd}
          and bizno = #{bizNo}
    </select>
    <delete id="deleteCmp">
        delete from tb_pils_cmpmbr where bizno = #{bizNo}
    </delete>
    <select id="listCount" resultType="int">
        SELECT COUNT(1)
        from tb_pils_cmpmbr A join tb_pils_mbr B
        on A.bizno =B.bizno
        WHERE 1 = 1
          and A.cmp_mbr_cd = #{mem_cd}
          and b.manage_cd ='M501'
        <if test="tag != null and tag != ''">
            and ${tag} like CONCAT('%',#{keyword},'%')
        </if>
    </select>
    <select id="memManageList" resultMap="CmpMemberVo">
        select user_id       as id
             , nm            as name
             , b.cd_nm       as management_cd
             , mbphno        as mbphno
             , psitn_dept_nm as deptNm
             , pstn as position
             , c.cmp_nm as cmpNm
        from tb_pils_mbr A,
            ( select cd, cd_nm from tb_cd_data where cd_grp = 'M500') B,
            (select bizno,cmp_nm,joincmp from tb_pils_cmpmbr tpc where cmp_mbr_cd='M302') C
        where A.manage_cd =B.cd
          and A.bizno =c.bizno
        <if test="tag != null and tag != ''">
            and ${tag} like CONCAT('%',#{keyword},'%')
        </if>
        <if test="sort != null and sort != ''">
                order by ${sort} asc, cd='M501'desc
        </if>
        <if test="pageIndex > 0">
            LIMIT #{pageUnit} OFFSET #{firstIndex}
        </if>
    </select>
    <select id="memManageListCount" resultType="int">
        SELECT COUNT(1)
        from tb_pils_mbr A,
        ( select cd, cd_nm from tb_cd_data where cd_grp = 'M500') B,
        (select bizno,cmp_nm,joincmp from tb_pils_cmpmbr tpc where cmp_mbr_cd='M302') C
        where A.manage_cd =B.cd
        and A.bizno =c.bizno
        <if test="tag != null and tag != ''">
            and ${tag} like CONCAT('%',#{keyword},'%')
        </if>
    </select>
    <select id="memEdit" resultMap="CmpMemberVo">
        select nm            as name
             , mbphno        as mbphno
             , psitn_dept_nm as deptNm
             , pstn as position
             , email_addr    as email
             , telno         as memTelNo
             , faxno         as memFaxNo
             , user_id       as id
             , bizno         as bizNo
        from tb_pils_mbr
        where user_id =#{id}
    </select>
    <delete id="deleteMem">
        delete from tb_pils_mbr where bizno = #{bizNo} and user_id = #{id}
    </delete>
    <update id="updateMem">
        update tb_pils_mbr
        set nm            = #{name}
          , mbphno        = #{mbphno}
          , psitn_dept_nm = #{deptNm}
          , pstn          = #{position}
          , email_addr    = #{email}
          , telno         = #{memTelNo}
          , faxno         = #{memFaxNo}
          , upd_dt        = current_date
        where user_id = #{id}
    </update>
    <update id="changePw">
        update tb_pils_mbr
        set pswd = encode(encrypt(convert_to(#{passwd}, 'utf8'), 'ENC_KEY', 'aes'), 'hex')
        where user_id = #{id}
    </update>
    <insert id="tracePost">
        insert into tb_pils_trace( title
                                 , cont
                                 , rgst_dt)
        values ( #{title}
               , #{cont}
               , current_timestamp)
        <selectKey keyProperty="seq" resultType="integer" order="AFTER">
            SELECT MAX(seq) FROM tb_pils_trace;
        </selectKey>
    </insert>
    <select id="traceList" resultMap="TraceVO">
        with src as (
            select
                seq     as seq,
                title   as title,
                cont    as cont,
                rgst_dt as rgst_dt,
                (	select
                         min(atch_sn)
                     from
                         tb_atch ta
                     where
                         bbs_id = '5'
                       and bbs_sn = tpt.seq) as atch_sn
            from
                tb_pils_trace tpt
        )
        select
            s.*,
            a.file_path,
            a.saved_file_nm,
            a.file_nm
        from
            src s
                left join tb_atch a
                          on s.atch_sn = a.atch_sn
        order by
            rgst_dt desc
    </select>
    <select id="traceView" resultMap="TraceVO">
        select seq     as seq
             , title   as title
             , cont    as cont
             , rgst_dt as rgst_dt
        from tb_pils_trace tpt
        where seq = #{seq}
    </select>
    <select id="traceCount" resultType="int">
        SELECT COUNT(1)
        FROM tb_pils_trace
        WHERE 1 = 1
    </select>
    <update id="traceUpdate">
        update tb_pils_trace
        set title =#{title}
          , cont  =#{cont}
        where seq = #{seq}
    </update>

    <delete id="traceDelete">
        Delete
        from tb_pils_trace
        where seq = #{seq}
    </delete>
    <select id="recomList" resultMap="RcmdVO">
        select apply_cmp_nm as apply_cmpNm
             , apply_bizno
             , apply_ceo
             , apply_telno as apply_telNo
             , apply_email
             , rcmd_cmp_nm as rcmd_cmpNm
             , rcmd_bizno
             , rcmd_telno as rcmd_telNo
             , rcmd_email
             , rcmd_detail
             , appdt
             , status
             , rcmd_no
        from tb_pils_rcmd
        order by appdt desc
    </select>
    <select id="recomCount" resultType="int">
        SELECT COUNT(1)
        FROM tb_pils_rcmd
        WHERE 1 = 1
    </select>
    <select id="banCount" resultType="int">
        SELECT COUNT(1)
        FROM tb_pils_banner
        WHERE 1 = 1
    </select>
    <select id="banList" resultMap="BannerVO">
        select *
        from tb_pils_banner
        where stts =1
        order by regist_dt desc
    </select>
    <insert id="banPost" parameterType="kr.co.xicom.front.model.BannerVO">
        INSERT INTO tb_pils_banner (
        ban_nm,
        site_url,
        stts,
        sort_seq,
        regist_dt,
        file_nm,
        file_size,
        file_ty,
        pc_img_path,
        mobile_img_path
        )
        VALUES(
        #{banNm},
        #{siteUrl},
        #{stts},
        #{sortSeq},
        NOW(),
        #{fileNm},
        #{fileSize},
        #{fileType},
        #{pcImgPath},
        #{mobileImgPath}
        )
    </insert>
    <select id="bannerView" resultMap="BannerVO">
        select
            ban_nm as banNm,
            site_url as siteUrl,
            stts as stts,
            sort_seq as sortSeq,
            regist_dt as registDt,
            pc_img_path as pcImgPath,
            mobile_img_path as mobileImgPath
        from tb_pils_banner
        where stts = 1
        and ban_sn = #{banSeq}
        order by regist_dt desc
    </select>
    <update id="bannerDelete">
        update tb_pils_banner
        set stts = #{stts}
        where ban_sn = #{banSeq}
    </update>
</mapper>