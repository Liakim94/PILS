<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.xicom.cms.service.mapper.BulletinMapper">
    
    
    <update id="addBulletin">
        INSERT INTO tb_bbs_bkdw (CD_GRP, DATE, VL)
        VALUES(#{ctgr}, #{dt}, #{val}::INT4)
    </update>
    
    <delete id="deleteBulletin">
        DELETE FROM TB_BBS_BKDW WHERE CD_GRP = #{ctgr} AND DATE = #{dt}
    </delete>
    
    <select id="getBulletin" resultType="egovMap">
        SELECT T.CD_GRP     AS ctgr
        , T.DATE            AS dt   
        , T.VL              AS val  
        , (SELECT CD_NM FROM tb_cd_data WHERE CD_GRP = '10000' AND CD = T.CD_GRP ) as CTGR_NM 
        FROM TB_BBS_BKDW T
        WHERE 1=1
        ORDER BY DATE DESC
    </select>
    
    
    
    <select id="getBulletinDashboard" resultType="egovMap">
        SELECT ((b.ctgr1/a.ctgr1::float)*100)-100 val1, ((b.ctgr2/a.ctgr2::float)*100)-100 val2, ((b.ctgr3/a.ctgr3::float)*100)-100 val3, ((b.ctgr4/a.ctgr4::float)*100)-100 val4,
            ABS(((b.ctgr1/a.ctgr1::float)*100)-100) TEXT1,
            ABS(((b.ctgr2/a.ctgr2::float)*100)-100) TEXT2,
            ABS(((b.ctgr3/a.ctgr3::float)*100)-100) TEXT3,
            ABS(((b.ctgr4/a.ctgr4::float)*100)-100) TEXT4
        FROM(
        SELECT MAX(ctgr1) ctgr1, MAX(ctgr2) ctgr2, MAX(ctgr3) ctgr3, MAX(ctgr4) ctgr4 
        FROM (
        SELECT case when CD_GRP = '1' then VL end ctgr1,
        case when CD_GRP = '2' then VL end ctgr2,
        case when CD_GRP = '3' then VL end ctgr3,
        case when CD_GRP = '4' then VL end ctgr4
        FROM (
        SELECT 'Y' D
        , SUM(VL) VL
        , CD_GRP
        , TO_CHAR(CAST(DATE AS DATE),'YYYY') yyyy
        FROM TB_BBS_BKDW
        WHERE TO_CHAR(CAST(DATE AS DATE),'YYYY') = TO_CHAR((SELECT NOW() + INTERVAL '-1 YEAR'), 'YYYY')
        GROUP BY CD_GRP, TO_CHAR(CAST(DATE AS DATE),'YYYY')
        ) t
        ) s
        ) a,
        (
        SELECT MAX(ctgr1) ctgr1, MAX(ctgr2) ctgr2, MAX(ctgr3) ctgr3, MAX(ctgr4) ctgr4 
        FROM (
        SELECT case when CD_GRP = '1' then VL end ctgr1,
        case when CD_GRP = '2' then VL end ctgr2,
        case when CD_GRP = '3' then VL end ctgr3,
        case when CD_GRP = '4' then VL end ctgr4
        FROM (
        SELECT 'T' D, SUM(VL) VL, CD_GRP, TO_CHAR(CAST(DATE AS DATE),'YYYY') yyyy
        FROM TB_BBS_BKDW
        WHERE TO_CHAR(CAST(DATE AS DATE),'YYYY') = TO_CHAR(NOW(), 'YYYY')
        GROUP BY CD_GRP, TO_CHAR(CAST(DATE AS DATE),'YYYY')
        ) t
        ) s
        )b
    
    </select>
    

</mapper>
